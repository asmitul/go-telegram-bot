groups:
  - name: telegram_bot_alerts
    interval: 30s
    rules:
      # Bot 服务宕机告警
      - alert: BotDown
        expr: up{job="telegram-bot"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Telegram Bot 服务宕机"
          description: "Bot 服务已经宕机超过 1 分钟"

      # 高错误率告警
      - alert: HighErrorRate
        expr: |
          rate(bot_command_errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "命令错误率过高"
          description: "过去 5 分钟内错误率超过 10%"

      # 响应时间过长告警
      - alert: HighResponseTime
        expr: |
          histogram_quantile(0.95, rate(bot_command_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "命令响应时间过长"
          description: "95% 的请求响应时间超过 2 秒"

      # 内存使用率告警
      - alert: HighMemoryUsage
        expr: |
          (process_resident_memory_bytes / 1024 / 1024) > 512
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "内存使用率过高"
          description: "内存使用超过 512MB"

  - name: mongodb_alerts
    interval: 30s
    rules:
      # MongoDB 连接数告警
      - alert: MongoDBHighConnections
        expr: mongodb_connections{state="current"} > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MongoDB 连接数过高"
          description: "当前连接数超过 100"

      # MongoDB 宕机告警
      - alert: MongoDBDown
        expr: up{job="mongodb"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "MongoDB 服务宕机"
          description: "MongoDB 已经宕机超过 1 分钟"

      # MongoDB 复制延迟告警
      - alert: MongoDBReplicationLag
        expr: mongodb_replset_member_replication_lag > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MongoDB 复制延迟过高"
          description: "复制延迟超过 10 秒"

  - name: system_alerts
    interval: 30s
    rules:
      # CPU 使用率告警
      - alert: HighCPUUsage
        expr: |
          100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "CPU 使用率过高"
          description: "CPU 使用率超过 80%"

      # 磁盘空间告警
      - alert: LowDiskSpace
        expr: |
          (node_filesystem_avail_bytes / node_filesystem_size_bytes) * 100 < 10
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "磁盘空间不足"
          description: "可用磁盘空间少于 10%"