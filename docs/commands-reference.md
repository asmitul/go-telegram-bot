# Telegram Bot 命令参考

## 概述

本文档描述了 Telegram Bot 的所有可用命令、参数格式、权限要求和错误处理。这是面向 Bot 使用者的命令手册。

## 目录

- [命令列表](#命令列表)
- [权限系统](#权限系统)
- [参数格式](#参数格式)
- [错误码说明](#错误码说明)
- [使用示例](#使用示例)

---

## 命令列表

### 1. `/ping` - 测试命令

**描述**: 测试 Bot 是否在线并响应

**用途**: 检查 Bot 的可用性和响应速度

**权限要求**: `PermissionUser` (所有用户)

**参数**: 无

**响应**:
```
🏓 Pong!
```

**使用示例**:
```
/ping
```

---

### 2. `/help` - 帮助命令

**描述**: 显示所有可用命令的帮助信息

**用途**: 查看 Bot 支持的所有命令及其说明

**权限要求**: `PermissionUser` (所有用户)

**参数**:
- `[command_name]` (可选): 查看特定命令的详细帮助

**响应**:
- 无参数: 显示所有命令列表
- 有参数: 显示特定命令的详细说明

**使用示例**:
```
/help
```

---

### 3. `/mute` - 禁言用户

**描述**: 限制用户发送消息的权限

**用途**: 临时限制违规用户发言

**权限要求**: `PermissionAdmin` (管理员及以上)

**参数**:
- `[user]` (必需): 被禁言的用户
  - 回复用户消息，或
  - 提及用户 (@username)
- `[duration]` (可选): 禁言时长
  - 格式: `数字+单位`
  - 单位: `m` (分钟), `h` (小时), `d` (天)
  - 默认: 1 小时

**响应**:
```
✅ 用户 @username 已被禁言 1 小时
✅ 用户 @username 已被禁言 30 分钟
```

**错误**:
- 权限不足: `❌ 权限不足`
- 参数错误: `❌ 请回复要禁言的用户消息或提及用户`

**使用示例**:
```
/mute                   # 回复用户消息，禁言1小时
/mute @spammer          # 禁言指定用户1小时
/mute 30m               # 回复用户消息，禁言30分钟
/mute @spammer 2h       # 禁言指定用户2小时
```

---

### 4. `/stats` - 统计信息

**描述**: 显示群组或用户的统计信息

**用途**: 查看群组活跃度和用户数据

**权限要求**: `PermissionUser` (所有用户)

**参数**:
- 无参数: 显示群组统计
- `@username`: 显示指定用户统计

**响应**:
```
📊 群组统计信息
👥 总用户数: 1234
📝 总消息数: 56789

📊 用户 @username 统计
📝 消息数: 567
```

**使用示例**:
```
/stats                  # 群组统计
/stats @username        # 用户统计
```

---

### 7. `/admin` - 管理员管理

**描述**: 添加或移除群组管理员

**用途**: 管理群组管理员权限

**权限要求**: `PermissionSuperAdmin` (超级管理员及以上)

**参数**:
- `add @user` - 添加管理员
- `remove @user` - 移除管理员
- `list` - 列出所有管理员

**响应**:
```
✅ 已将 @username 设置为管理员
✅ 已移除 @username 的管理员权限
📋 管理员列表:
  - @admin1 (Admin)
  - @admin2 (SuperAdmin)
```

**错误**:
- 权限不足: `❌ 权限不足，需要超级管理员权限`
- 参数错误: `❌ 用法: /admin add @user | /admin remove @user | /admin list`

**使用示例**:
```
/admin add @newadmin       # 添加管理员
/admin remove @oldadmin    # 移除管理员
/admin list                # 列出管理员
```

---

### 8. `/manage` - 命令管理

**描述**: 启用或禁用特定命令

**用途**: 灵活控制群组中可用的命令

**权限要求**: `PermissionAdmin` (管理员及以上)

**参数**:
- `enable <command>` - 启用命令
- `disable <command>` - 禁用命令
- `list` - 列出所有命令状态

**响应**:
```
✅ 命令 stats 已启用
✅ 命令 mute 已禁用
📋 命令状态:
  ✅ ping - 已启用
  ✅ help - 已启用
  ❌ stats - 已禁用
```

**错误**:
- 权限不足: `❌ 权限不足`
- 参数错误: `❌ 用法: /manage enable <command> | /manage disable <command> | /manage list`
- 命令不存在: `❌ 未知命令: xxx`

**使用示例**:
```
/manage enable stats       # 启用统计命令
/manage disable mute       # 禁用禁言命令
/manage list               # 列出命令状态
```

---

### 9. `/welcome` - 欢迎消息

**描述**: 设置新成员加入时的欢迎消息

**用途**: 自定义群组欢迎信息

**权限要求**: `PermissionAdmin` (管理员及以上)

**参数**:
- `set <message>` - 设置欢迎消息
- `show` - 显示当前欢迎消息
- `disable` - 禁用欢迎消息
- `enable` - 启用欢迎消息

**响应**:
```
✅ 欢迎消息已设置
📝 当前欢迎消息: 欢迎加入本群！
✅ 欢迎消息已禁用
✅ 欢迎消息已启用
```

**占位符**:
- `{username}` - 用户名
- `{firstname}` - 名字
- `{groupname}` - 群组名

**使用示例**:
```
/welcome set 欢迎 {username} 加入 {groupname}！
/welcome show
/welcome disable
/welcome enable
```

---

## 权限系统

### 权限等级

权限从低到高依次为:

| 权限级别 | 值 | 说明 | 可用命令 |
|---------|---|------|---------|
| `PermissionUser` | 1 | 普通用户 | ping, help, stats |
| `PermissionAdmin` | 2 | 管理员 | 所有用户命令 + mute, manage, welcome |
| `PermissionSuperAdmin` | 3 | 超级管理员 | 所有管理员命令 + admin |
| `PermissionOwner` | 4 | 群主 | 所有命令 |

### 权限规则

1. **权限继承**: 高级别权限包含所有低级别权限
2. **命令启用**: 即使有权限，命令也必须在群组中启用
3. **默认权限**: 新用户默认为 `PermissionUser`
4. **权限检查**: 每个命令执行前都会检查权限

---

## 参数格式

### 用户标识

- **回复消息**: 回复要操作的用户的消息
- **提及用户**: 使用 `@username` 格式
- **用户ID**: 某些内部操作使用数字 ID

### 时长格式

格式: `<数字><单位>`

支持的单位:
- `m` - 分钟 (minutes)
- `h` - 小时 (hours)
- `d` - 天 (days)

示例:
- `30m` - 30分钟
- `2h` - 2小时
- `7d` - 7天
- `1440m` - 1440分钟 (24小时)

### 文本参数

- **单个词**: 直接输入
- **多个词**: 用空格分隔
- **包含空格**: 目前不支持引号包裹，所有空格后的内容视为一个参数

---

## 错误码说明

### 权限错误

| 错误消息 | 含义 | 解决方案 |
|---------|------|---------|
| `❌ 权限不足` | 用户权限级别不够 | 联系管理员提升权限 |
| `❌ 命令未启用` | 命令在群组中被禁用 | 联系管理员启用命令 |
| `❌ 此 Bot 仅在群组中工作` | 在私聊中使用群组命令 | 在群组中使用 |

### 参数错误

| 错误消息 | 含义 | 解决方案 |
|---------|------|---------|
| `❌ 请回复要操作的用户消息或提及用户` | 未指定目标用户 | 回复消息或使用 @username |
| `❌ 无效的时长格式` | 时长格式错误 | 使用正确格式如 30m, 2h, 7d |
| `❌ 参数不足` | 缺少必需参数 | 查看命令帮助 |
| `❌ 未知命令: xxx` | 命令不存在 | 检查命令名称拼写 |

### 操作错误

| 错误消息 | 含义 | 解决方案 |
|---------|------|---------|
| `❌ 无法封禁管理员` | 尝试封禁权限更高的用户 | 只能操作低权限用户 |
| `❌ 操作失败` | Telegram API 调用失败 | 稍后重试或联系技术支持 |
| `❌ 数据库错误` | 数据存储失败 | 联系技术支持 |

### 业务错误

| 错误消息 | 含义 | 解决方案 |
|---------|------|---------|
| `⚠️ 用户未找到` | 指定用户不存在 | 检查用户名 |
| `⚠️ 群组未找到` | 群组未在系统中注册 | Bot 首次使用需初始化 |
| `⚠️ 警告记录未找到` | 用户没有警告记录 | 正常情况，无需处理 |

---

## 使用示例

### 场景 1: 管理违规用户

```bash
# 1. 直接禁言
/mute 1h
# 响应: ✅ 用户 @spammer 已被禁言 1 小时

# 2. 更长时间禁言
/mute 12h
# 响应: ✅ 用户 @spammer 已被禁言 12 小时
```

### 场景 2: 配置群组

```bash
# 1. 查看可用命令
/manage list
# 响应: 显示所有命令状态

# 2. 禁用某些命令
/manage disable stats
# 响应: ✅ 命令 stats 已禁用

# 3. 设置欢迎消息
/welcome set 欢迎 {username} 加入 {groupname}！请遵守群规。
# 响应: ✅ 欢迎消息已设置

# 4. 添加管理员
/admin add @newadmin
# 响应: ✅ 已将 @newadmin 设置为管理员
```

### 场景 3: 查看统计

```bash
# 1. 查看群组统计
/stats
# 响应: 显示群组总体统计

# 2. 查看用户统计
/stats @activeuser
# 响应: 显示该用户的详细统计
```

---

## 最佳实践

### 权限管理

1. **最小权限原则**: 只授予必要的权限
2. **定期审查**: 定期检查管理员列表
3. **权限分级**: 合理使用 Admin 和 SuperAdmin 级别

### 命令使用

1. **记录原因**: 操作时附带原因说明
2. **合理时长**: 根据违规严重程度设置时长

### 群组配置

1. **明确群规**: 配置清晰的欢迎消息
2. **按需启用**: 只启用必要的命令
3. **定期维护**: 定期清理警告记录

---

## 技术说明

### 命令注册

所有命令都实现了 `command.Handler` 接口:

```go
type Handler interface {
    Name() string
    Description() string
    Usage() string
    RequiredPermission() user.Permission
    IsEnabled(groupID int64) bool
    Handle(ctx *Context) error
}
```

### 中间件链

命令执行流程:
1. **日志中间件**: 记录命令执行
2. **限流中间件**: 防止滥用
3. **权限中间件**: 检查权限和启用状态
4. **命令处理器**: 执行具体逻辑

### 错误处理

- 所有错误都会记录日志
- 用户友好的错误消息
- 支持错误重试机制（针对网络错误）

---

## 更新日志

### v1.0.0 (2025-10-01)
- 初始版本
- 实现 9 个核心命令
- 完整的权限系统
- 详细的错误处理

---

## 支持

如有问题，请:
1. 查看本文档
2. 使用 `/help` 命令
3. 联系群组管理员
4. 提交 Issue 到项目仓库
